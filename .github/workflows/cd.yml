name: CD Pipeline

on:
  # This workflow is triggered when the "CI Pipeline" workflow completes successfully on the main branch
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    # Only run this job if the CI pipeline was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    # This job must run on your self-hosted runner
    runs-on: self-hosted 
    
    steps:
      - name: ⬇️ Download deployment artifact
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflowRunId = process.env.GITHUB_WORKFLOW_RUN_ID;
            
            // Wait for the artifact to be available
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: workflowRunId,
            });
            
            const downloadUrl = artifacts.data.artifacts.find(artifact => artifact.name === 'deployment-artifact').archive_download_url;
            
            await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifacts.data.artifacts[0].id,
              archive_format: 'zip',
            });

      - name: Unzip artifact
        run: |
          unzip -o -d . deployment-artifact.zip

      - name: 🚀 Deploy to Kubernetes
        run: kubectl apply -f k8s-manifests/
